name: Build and Deploy to EC2

on:
    push:
        branches: [main]

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3
            - name: Setup Node.js 20
              uses: actions/setup-node@v3
              with:
                node-version: '20'
                cache: 'npm'
                cache-dependency-path: bookhub-react/package-lock.json
            - name: Build React Frontend
              working-directory: bookhub-react
              env:
                VITE_API_URL: ${{ secrets.VITE_API_URL }}
              run: |
                echo "Installing React Depends"
                npm ci
                echo "Building React app..."
                npm run build
                echo "React build completed"
            - name: Copy React build to Spring Boot static resources
              run: |
                echo "Preparing static resources directory"
                mkdir -p webserver/src/main/resources/static
                rm -rf webserver/src/main/resources/static/*
                echo "Copying React build files..."
                cp -r bookhub-react/dist/* webserver/src/main/resources/static/
                echo "React file copied to spring boot static resources!"
            - name: Setup Java 21
              uses: actions/setup-java@v3
              with:
                java-version: '21'
                distribution: 'temurin'
            - name: Build with Maven
              run: cd webserver && mvn clean package -DskipTests
            - name: Copy JAR to EC2
              uses: appleboy/scp-action@v0.1.7
              with:
                host: ${{ secrets.EC2_HOST }}
                username: ${{ secrets.EC2_USER }}
                key: ${{ secrets.EC2_SSH_KEY }}
                source: "webserver/target/webserver-*.jar"
                target: "/home/${{ secrets.EC2_USER }}/"
                strip_components: 2
            - name: Deploy and Run JAR on EC2
              uses: appleboy/ssh-action@v0.1.7
              with:
                host: ${{ secrets.EC2_HOST }}
                username: ${{ secrets.EC2_USER }}
                key: ${{ secrets.EC2_SSH_KEY }}
                script: |
                  echo "Stopping existing webserver service..."
                  pkill -f 'webserver-*\.jar' || echo "No existing service to stop."
                  echo "Starting new webserver service..."
                  cd /home/${{ secrets.EC2_USER }}/
                  JAR_FILE=$(ls webserver-*.jar | head -n 1)

                  if [ -z "$JAR_FILE" ]; then
                    echo "No JAR file found to run."
                    exit 1
                  fi

                  echo "Running JAR file: $JAR_FILE"
                  nohup java -jar "$JAR_FILE" --spring.profiles.active=prod > bookhub.log 2>&1 &

                  echo "Webserver service started successfully."
                  echo "Deployment complete."
                  echo "You can check the logs with 'tail -f bookhub.log'."